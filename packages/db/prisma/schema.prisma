// Trading Fight Club - Database Schema
// @see Master-doc.md Section 6

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─────────────────────────────────────────────────────────────
// USER ROLES
// ─────────────────────────────────────────────────────────────
enum UserRole {
  USER
  ADMIN
}

enum UserStatus {
  ACTIVE
  BANNED
  DELETED
}

// ─────────────────────────────────────────────────────────────
// USERS
// ─────────────────────────────────────────────────────────────
model User {
  id            String     @id @default(uuid())
  handle        String     @unique
  walletAddress String?    @unique @map("wallet_address")
  avatarUrl     String?    @map("avatar_url")
  role          UserRole   @default(USER)
  status        UserStatus @default(ACTIVE)
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Ban/Delete tracking
  bannedAt     DateTime? @map("banned_at")
  bannedReason String?   @map("banned_reason")
  deletedAt    DateTime? @map("deleted_at")

  // Referral system
  referralCode String? @unique @map("referral_code")
  referredById String? @map("referred_by_id")

  pacificaConnection   PacificaConnection?
  fightParticipants    FightParticipant[]
  createdFights        Fight[]               @relation("FightCreator")
  leaderboardSnapshots LeaderboardSnapshot[]
  trades               Trade[]
  notifications        Notification[]
  referrals            Referral[]            @relation("Referrals")
  referredBy           Referral[]            @relation("ReferredBy")
  referralEarnings     ReferralEarning[]

  @@map("users")
}

// ─────────────────────────────────────────────────────────────
// PACIFICA CONNECTION (server-side only)
// @see Master-doc.md Section 5.1: Never expose keys to frontend
// ─────────────────────────────────────────────────────────────
model PacificaConnection {
  id String @id @default(uuid())

  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Pacifica account (public address) - safe to log
  accountAddress String @unique @map("account_address")

  // Encrypted private key stored in vault/secret manager reference
  // This field stores the vault path/reference, NOT the actual key
  vaultKeyReference String @map("vault_key_reference")

  // Builder code approval status
  builderCodeApproved Boolean @default(false) @map("builder_code_approved")

  isActive    Boolean  @default(true) @map("is_active")
  connectedAt DateTime @default(now()) @map("connected_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("pacifica_connections")
}

// ─────────────────────────────────────────────────────────────
// FIGHTS
// @see Master-doc.md Section 2: Format, Duration, Stake
// ─────────────────────────────────────────────────────────────
enum FightStatus {
  WAITING // Created, waiting for opponent
  LIVE // Both participants joined, fight in progress
  FINISHED // Duration elapsed, winner determined
  CANCELLED // Stale or manually cancelled
  NO_CONTEST // Anti-cheat: excluded from ranking (0-0, min volume, repeated matchup, same IP)
}

model Fight {
  id String @id @default(uuid())

  // Creator reference
  creatorId String @map("creator_id")
  creator   User   @relation("FightCreator", fields: [creatorId], references: [id])

  // Fight configuration
  // @see Master-doc.md Section 2.2: 5, 15, 30, 60, 120, 240 minutes
  durationMinutes Int @map("duration_minutes")

  // @see Master-doc.md Section 2.3: 100, 250, 500, 1000, 2500, 5000 USDC
  stakeUsdc Int @map("stake_usdc")

  // Lifecycle
  status    FightStatus @default(WAITING)
  createdAt DateTime    @default(now()) @map("created_at")
  startedAt DateTime?   @map("started_at") // Set when LIVE
  endedAt   DateTime?   @map("ended_at") // Set when FINISHED

  // Result (set when FINISHED)
  winnerId String? @map("winner_id")
  isDraw   Boolean @default(false) @map("is_draw")

  updatedAt DateTime @updatedAt @map("updated_at")

  // Settlement lock fields (prevents race conditions between realtime engine and reconcile job)
  // @see docs/Agents/Fight-Enginer-Scanner.md
  settlingAt DateTime? @map("settling_at") // Timestamp when settlement started
  settlingBy String?   @map("settling_by") // Process ID holding the lock (e.g., "realtime-abc123", "job-reconcile")

  participants FightParticipant[]
  trades       FightTrade[]
  snapshots    FightSnapshot[]
  sessions     FightSession[]
  violations   AntiCheatViolation[]

  @@index([status])
  @@index([createdAt])
  @@index([settlingAt])
  @@map("fights")
}

// ─────────────────────────────────────────────────────────────
// FIGHT PARTICIPANTS
// ─────────────────────────────────────────────────────────────
model FightParticipant {
  id String @id @default(uuid())

  fightId String @map("fight_id")
  fight   Fight  @relation(fields: [fightId], references: [id], onDelete: Cascade)

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  // Slot: 'A' or 'B' (first to join is A, second is B)
  slot String

  joinedAt DateTime @default(now()) @map("joined_at")

  // Snapshot of positions when fight starts
  // Used to exclude pre-existing positions from PnL calculation
  // Format: [{ symbol: "BTC", amount: "0.001", entry_price: "90000" }, ...]
  initialPositions Json? @map("initial_positions")

  // Maximum capital exposure used during the fight (never decreases)
  // Used to enforce stake limit - once capital is used, it can't be reused
  maxExposureUsed Decimal @default(0) @map("max_exposure_used") @db.Decimal(18, 6)

  // Final results (set when FINISHED)
  finalPnlPercent Decimal? @map("final_pnl_percent") @db.Decimal(18, 8)
  finalScoreUsdc  Decimal? @map("final_score_usdc") @db.Decimal(18, 6)
  tradesCount     Int      @default(0) @map("trades_count")

  // External trades detection (trades made outside TradeFightClub during fight)
  externalTradesDetected Boolean  @default(false) @map("external_trades_detected")
  externalTradeIds       String[] @default([]) @map("external_trade_ids")

  // Symbols blocked for trading (positions held at fight start)
  blockedSymbols String[] @default([]) @map("blocked_symbols")

  @@unique([fightId, userId])
  @@unique([fightId, slot])
  @@map("fight_participants")
}

// ─────────────────────────────────────────────────────────────
// FIGHT TRADES
// Fills during fight window
// @see Master-doc.md Section 2.4: same fill can contribute to multiple fights
// ─────────────────────────────────────────────────────────────
model FightTrade {
  id String @id @default(uuid())

  fightId String @map("fight_id")
  fight   Fight  @relation(fields: [fightId], references: [id], onDelete: Cascade)

  participantUserId String @map("participant_user_id")

  // Pacifica fill data
  pacificaHistoryId BigInt  @map("pacifica_history_id") // history_id from Pacifica
  pacificaOrderId   BigInt? @map("pacifica_order_id")

  symbol   String
  side     String // BUY, SELL
  amount   Decimal  @db.Decimal(18, 8)
  price    Decimal  @db.Decimal(18, 8)
  fee      Decimal  @db.Decimal(18, 8)
  pnl      Decimal? @db.Decimal(18, 8) // Realized PnL from this trade
  leverage Int? // Leverage used for this trade (from frontend)

  executedAt DateTime @map("executed_at") // Pacifica's created_at
  recordedAt DateTime @default(now()) @map("recorded_at")

  @@unique([fightId, pacificaHistoryId])
  @@index([fightId, participantUserId])
  @@map("fight_trades")
}

// ─────────────────────────────────────────────────────────────
// ALL TRADES (for platform metrics)
// Stores ALL trades executed through TFC, regardless of fight status
// Used for: total volume, fee revenue, user activity metrics
// ─────────────────────────────────────────────────────────────
model Trade {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Pacifica fill data
  pacificaHistoryId BigInt  @unique @map("pacifica_history_id")
  pacificaOrderId   BigInt? @map("pacifica_order_id")

  symbol   String
  side     String // BUY, SELL
  amount   Decimal  @db.Decimal(18, 8)
  price    Decimal  @db.Decimal(18, 8)
  fee      Decimal  @db.Decimal(18, 8)
  pnl      Decimal? @db.Decimal(18, 8)
  leverage Int?

  // Optional fight reference (if trade was during a fight)
  fightId String? @map("fight_id")

  executedAt DateTime @map("executed_at")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([executedAt])
  @@index([symbol])
  @@map("trades")
}

// ─────────────────────────────────────────────────────────────
// FIGHT SNAPSHOTS (for PnL timeline)
// @see Master-doc.md Section 6
// ─────────────────────────────────────────────────────────────
model FightSnapshot {
  id String @id @default(uuid())

  fightId String @map("fight_id")
  fight   Fight  @relation(fields: [fightId], references: [id], onDelete: Cascade)

  timestamp DateTime @default(now())

  // Participant A scores
  participantAUserId      String  @map("participant_a_user_id")
  participantAPnlPercent  Decimal @map("participant_a_pnl_percent") @db.Decimal(18, 8)
  participantAScoreUsdc   Decimal @map("participant_a_score_usdc") @db.Decimal(18, 6)
  participantATradesCount Int     @map("participant_a_trades_count")

  // Participant B scores
  participantBUserId      String  @map("participant_b_user_id")
  participantBPnlPercent  Decimal @map("participant_b_pnl_percent") @db.Decimal(18, 8)
  participantBScoreUsdc   Decimal @map("participant_b_score_usdc") @db.Decimal(18, 6)
  participantBTradesCount Int     @map("participant_b_trades_count")

  // Leader at this point
  leaderId String? @map("leader_id")

  @@index([fightId, timestamp])
  @@map("fight_snapshots")
}

// ─────────────────────────────────────────────────────────────
// FIGHT SESSIONS (Anti-Cheat: IP/UserAgent tracking)
// @see Anti-Cheat.md
// ─────────────────────────────────────────────────────────────
model FightSession {
  id String @id @default(uuid())

  fightId String @map("fight_id")
  fight   Fight  @relation(fields: [fightId], references: [id], onDelete: Cascade)

  userId String @map("user_id")

  // IP and device information
  ipAddress String  @map("ip_address")
  userAgent String? @map("user_agent")

  // Session type: 'join' when joining fight, 'trade' when making trades
  sessionType String @map("session_type")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([fightId])
  @@index([userId])
  @@index([ipAddress])
  @@map("fight_sessions")
}

// ─────────────────────────────────────────────────────────────
// ANTI-CHEAT VIOLATIONS (Audit log for flagged fights)
// @see Anti-Cheat.md
// ─────────────────────────────────────────────────────────────
model AntiCheatViolation {
  id String @id @default(uuid())

  fightId String @map("fight_id")
  fight   Fight  @relation(fields: [fightId], references: [id], onDelete: Cascade)

  // Which rule was violated
  ruleCode String @map("rule_code") // ZERO_ZERO, MIN_VOLUME, REPEATED_MATCHUP, SAME_IP

  // Rule details
  ruleName    String @map("rule_name")
  ruleMessage String @map("rule_message")

  // Additional context (JSON for flexibility)
  metadata Json?

  // Action taken
  actionTaken String @map("action_taken") // NO_CONTEST, FLAGGED

  createdAt DateTime @default(now()) @map("created_at")

  @@index([fightId])
  @@index([ruleCode])
  @@index([createdAt])
  @@map("anti_cheat_violations")
}

// ─────────────────────────────────────────────────────────────
// LEADERBOARD SNAPSHOT
// @see Master-doc.md Section 6, 11
// Materialized view refreshed by job
// ─────────────────────────────────────────────────────────────
model LeaderboardSnapshot {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  range String // 'weekly' | 'all_time'

  // Aggregated stats from FINISHED fights
  totalFights   Int     @default(0) @map("total_fights")
  wins          Int     @default(0)
  losses        Int     @default(0)
  draws         Int     @default(0)
  totalPnlUsdc  Decimal @default(0) @map("total_pnl_usdc") @db.Decimal(18, 6)
  avgPnlPercent Decimal @default(0) @map("avg_pnl_percent") @db.Decimal(18, 8)

  rank Int?

  calculatedAt DateTime @default(now()) @map("calculated_at")

  @@unique([userId, range])
  @@index([range, rank])
  @@map("leaderboard_snapshots")
}

// ─────────────────────────────────────────────────────────────
// WEEKLY PRIZE POOL
// Tracks weekly fee collection and prize distribution
// 1st: 5%, 2nd: 3%, 3rd: 2% of total weekly fees
// ─────────────────────────────────────────────────────────────
model WeeklyPrizePool {
  id String @id @default(uuid())

  // Week boundaries (Sunday 00:00:00 UTC to Saturday 23:59:59 UTC)
  weekStartDate DateTime @map("week_start_date")
  weekEndDate   DateTime @map("week_end_date")

  // Fee totals for the week
  totalFeesCollected Decimal @default(0) @map("total_fees_collected") @db.Decimal(18, 6)
  totalPrizePool     Decimal @default(0) @map("total_prize_pool") @db.Decimal(18, 6) // 10% of fees

  // Distribution status
  isFinalized   Boolean   @default(false) @map("is_finalized") // Week ended, prizes calculated
  isDistributed Boolean   @default(false) @map("is_distributed") // Prizes paid out
  finalizedAt   DateTime? @map("finalized_at")
  distributedAt DateTime? @map("distributed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  prizes WeeklyPrize[]

  @@unique([weekStartDate])
  @@index([isFinalized, isDistributed])
  @@map("weekly_prize_pools")
}

enum PrizeStatus {
  PENDING // Prize calculated but week not ended
  EARNED // Week ended, prize confirmed
  DISTRIBUTED // Prize paid out to user
}

model WeeklyPrize {
  id String @id @default(uuid())

  prizePoolId String          @map("prize_pool_id")
  prizePool   WeeklyPrizePool @relation(fields: [prizePoolId], references: [id], onDelete: Cascade)

  userId String @map("user_id")

  // Position (1, 2, or 3)
  rank Int

  // Prize details
  prizePercentage Decimal @map("prize_percentage") @db.Decimal(5, 2) // 5.00, 3.00, 2.00
  prizeAmount     Decimal @map("prize_amount") @db.Decimal(18, 6)

  // User stats at time of winning (for display)
  totalPnlUsdc Decimal @map("total_pnl_usdc") @db.Decimal(18, 6)
  totalFights  Int     @map("total_fights")
  wins         Int
  userHandle   String  @map("user_handle")

  status        PrizeStatus @default(PENDING)
  distributedAt DateTime?   @map("distributed_at")
  txSignature   String?     @map("tx_signature") // Solana transaction signature for verification

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([prizePoolId, rank])
  @@unique([prizePoolId, userId])
  @@index([userId])
  @@index([status])
  @@map("weekly_prizes")
}

// ─────────────────────────────────────────────────────────────
// TFC ORDER ACTIONS
// Logs ALL order-related actions made through TradeFightClub
// Used for: full audit trail, TFC-only filtering, analytics
// ─────────────────────────────────────────────────────────────
enum OrderActionType {
  MARKET_ORDER // Market order placed
  LIMIT_ORDER // Limit order placed
  CANCEL_ORDER // Order cancelled
  CANCEL_ALL // All orders cancelled
  SET_TPSL // TP/SL set on position
  CANCEL_STOP // Stop order (TP/SL) cancelled
  CREATE_STOP // Stop order created
  EDIT_ORDER // Order edited
  ORDER_FILLED // Order was filled (links to Trade)
  ORDER_PARTIAL // Order was partially filled
}

model TfcOrderAction {
  id String @id @default(uuid())

  // User who performed the action
  userId        String @map("user_id")
  walletAddress String @map("wallet_address")

  // Action details
  actionType OrderActionType @map("action_type")

  // Order information
  symbol    String
  side      String? // bid/ask or LONG/SHORT
  orderType String?  @map("order_type") // MARKET, LIMIT, etc.
  amount    Decimal? @db.Decimal(18, 8)
  price     Decimal? @db.Decimal(18, 8) // For limit orders

  // TP/SL information
  takeProfit Decimal? @map("take_profit") @db.Decimal(18, 8)
  stopLoss   Decimal? @map("stop_loss") @db.Decimal(18, 8)

  // Pacifica response data
  pacificaOrderId   BigInt? @map("pacifica_order_id")
  pacificaHistoryId BigInt? @map("pacifica_history_id")

  // Fill information (if applicable)
  filledAmount Decimal? @map("filled_amount") @db.Decimal(18, 8)
  filledPrice  Decimal? @map("filled_price") @db.Decimal(18, 8)
  fee          Decimal? @db.Decimal(18, 8)
  pnl          Decimal? @db.Decimal(18, 8)

  // Additional context
  leverage Int?
  fightId  String? @map("fight_id") // If during a fight

  // Success/failure
  success      Boolean @default(true)
  errorMessage String? @map("error_message")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([walletAddress])
  @@index([createdAt])
  @@index([actionType])
  @@index([symbol])
  @@map("tfc_order_actions")
}

// ─────────────────────────────────────────────────────────────
// NOTIFICATIONS
// User notifications persisted from toast messages
// ─────────────────────────────────────────────────────────────
model Notification {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type    String // "TRADE", "ORDER", "FIGHT", "SYSTEM"
  title   String
  message String

  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

// ─────────────────────────────────────────────────────────────
// REFERRAL SYSTEM
// 3-tier referral system with commission tracking
// ─────────────────────────────────────────────────────────────
model Referral {
  id String @id @default(uuid())

  // Who referred whom
  referrerId String @map("referrer_id")
  referrer   User   @relation("Referrals", fields: [referrerId], references: [id], onDelete: Cascade)

  referredId String @map("referred_id")
  referred   User   @relation("ReferredBy", fields: [referredId], references: [id], onDelete: Cascade)

  // Tier level (1, 2, or 3)
  tier Int

  // When the referral was created
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([referrerId, referredId])
  @@index([referrerId, tier])
  @@index([referredId])
  @@map("referrals")
}

model ReferralEarning {
  id String @id @default(uuid())

  // Who earned the commission
  referrerId String @map("referrer_id")
  referrer   User   @relation(fields: [referrerId], references: [id], onDelete: Cascade)

  // Who made the trade
  traderId String @map("trader_id")

  // Which trade generated this earning
  tradeId String @map("trade_id")

  // Tier level (1, 2, or 3)
  tier Int

  // Trade details (snapshot for display)
  symbol     String
  tradeFee   Decimal @map("trade_fee") @db.Decimal(18, 8) // Original fee from trade
  tradeValue Decimal @map("trade_value") @db.Decimal(18, 8) // amount * price

  // Commission calculation
  commissionPercent Decimal @map("commission_percent") @db.Decimal(5, 2) // 34.00, 12.00, 4.00
  commissionAmount  Decimal @map("commission_amount") @db.Decimal(18, 8) // tradeFee * commissionPercent

  // Status
  isPaid Boolean @default(false) @map("is_paid")

  // Timestamps
  earnedAt DateTime  @default(now()) @map("earned_at")
  paidAt   DateTime? @map("paid_at")

  @@index([referrerId, isPaid])
  @@index([traderId])
  @@index([earnedAt])
  @@map("referral_earnings")
}

model ReferralPayout {
  id String @id @default(uuid())

  // Who received the payout
  userId String @map("user_id")

  // Amount paid
  amount Decimal @db.Decimal(18, 8)

  // Wallet address where funds were sent
  walletAddress String @map("wallet_address")

  // Transaction details
  txSignature String? @map("tx_signature") // Solana transaction signature

  // Status
  status String @default("pending") // pending, processing, completed, failed

  // Timestamps
  createdAt   DateTime  @default(now()) @map("created_at")
  processedAt DateTime? @map("processed_at")

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("referral_payouts")
}

// ─────────────────────────────────────────────────────────────
// BETA WHITELIST
// Manages closed beta access
// ─────────────────────────────────────────────────────────────
model BetaWhitelist {
  id              String    @id @default(uuid())
  walletAddress   String    @unique @map("wallet_address")
  status          String    @default("pending") // pending, approved, rejected
  ipAddress       String?   @map("ip_address")
  country         String?
  isp             String?
  userAgent       String?   @map("user_agent")
  multiIpFlag     Boolean   @default(false) @map("multi_ip_flag")
  deviceMatchFlag Boolean   @default(false) @map("device_match_flag")
  ipAccountCount  Int       @default(1) @map("ip_account_count")
  appliedAt       DateTime  @default(now()) @map("applied_at")
  approvedAt      DateTime? @map("approved_at")

  @@index([ipAddress])
  @@map("beta_whitelist")
}

// ─────────────────────────────────────────────────────────────
// FIGHT AUDIT LOG
// Diagnostic table to capture ALL fight status/settling changes
// Used to identify the source of race conditions in settlement
// @see docs/Agents/Fight-Enginer-Scanner.md
// ─────────────────────────────────────────────────────────────
model FightAuditLog {
  id Int @id @default(autoincrement())

  fightId String @map("fight_id")

  // Status change tracking
  oldStatus String? @map("old_status")
  newStatus String? @map("new_status")

  // Settlement lock tracking
  oldSettlingBy String?   @map("old_settling_by")
  newSettlingBy String?   @map("new_settling_by")
  oldSettlingAt DateTime? @map("old_settling_at")
  newSettlingAt DateTime? @map("new_settling_at")

  // PostgreSQL metadata (set by trigger)
  changedAt       DateTime @default(now()) @map("changed_at")
  pgBackendPid    Int?     @map("pg_backend_pid")
  applicationName String?  @map("application_name")

  @@index([fightId])
  @@index([changedAt])
  @@map("fight_audit_log")
}
